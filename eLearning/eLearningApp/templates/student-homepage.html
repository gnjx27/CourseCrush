{% extends 'base.html' %}
{% block content %}
<div class="container-fluid py-4">
  <!-- Dashboard Header with Profile Summary -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
        <div class="card-body p-0">
          <div class="row g-0">
            <div class="col-md-4 bg-light p-4 d-flex align-items-center justify-content-center border-end">
              <div class="text-center">
                <div class="position-relative d-inline-block mb-3">
                  <img id="photo" src="" alt="Profile Photo" class="rounded-circle object-fit-cover border shadow-sm"
                    style="width: 100px; height: 100px;">
                </div>
                <h4 id="fullname" class="fw-bold mb-1">Loading...</h4>
                <p id="username" class="text-muted mb-1">Loading...</p>
                <span id="role" class="badge bg-info text-white mb-2">Loading...</span>
              </div>
            </div>
            <div class="col-md-8 p-4">
              <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold mb-0">Student Dashboard</h3>
                <div>
                  <button class="btn btn-primary rounded-pill px-3">
                    <a style="text-decoration: none; color: white;"
                      href="/explore/">Find Courses</a>
                  </button>
                </div>
              </div>
              <p id="status" class="text-muted mb-0">Loading status...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="row g-4">
    <!-- My Courses Section -->
    <div class="col-lg-8">
      <div class="card border-0 rounded-4 shadow-sm h-100">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center border-0">
          <h5 class="fw-bold mb-0">
            <i class="bi bi-book me-2 text-primary"></i>My Courses
          </h5>
        </div>
        <div class="card-body">
          <div id="courses-container" class="row g-3 pb-1" style="max-height: 600px; overflow-y: auto;">
            <!-- Courses will be dynamically loaded here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Right Sidebar: Notifications & Chat -->
    <div class="col-lg-4">
      <!-- Notifications Panel -->
      <div class="card border-0 rounded-4 shadow-sm mb-4">
        <div class="card-header bg-primary text-white py-3 rounded-top-4">
          <div class="d-flex align-items-center">
            <i class="bi bi-bell-fill me-2"></i>
            <h5 class="mb-0 fw-bold">Notifications</h5>
          </div>
        </div>
        <div class="card-body p-0">
          <div id="notifications-container" style="max-height: 250px; overflow-y: auto;" class="p-3">
            <!-- Notifications will be filled by JS -->
          </div>
        </div>
      </div>

      <!-- Chat Panel -->
      <div class="card border-0 rounded-4 shadow-sm">
        <div class="card-header bg-info text-white py-3 rounded-top-4">
          <div class="d-flex align-items-center">
            <i class="bi bi-chat-dots-fill me-2"></i>
            <h5 class="mb-0 fw-bold">Global Chat</h5>
          </div>
        </div>
        <div class="card-body p-3">
          <div id="chat-container" class="bg-light rounded p-3 mb-3" style="height: 200px; overflow-y: auto;">
            <!-- Messages will appear here -->
          </div>
          <div class="input-group">
            <input id="chat-message-input" type="text" class="form-control border-end-0 rounded-start-pill" 
              placeholder="Type your message...">
            <button id="chat-message-submit" class="btn btn-primary rounded-end-pill px-3">
              Send
            </button>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
   const chatContainer = document.getElementById('chat-container');
  const chatSocket = new WebSocket(
    'ws://'
    + window.location.host
    + '/ws/chat/'
    + 'global'
    + '/'
  );

  // Function to create a message element
  function createMessageElement(username, message, created_at) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'mb-2';

    const userBadge = document.createElement('span');
    userBadge.className = 'badge bg-success me-2';
    userBadge.textContent = username;

    const messageText = document.createElement('span');
    messageText.textContent = message;

    const timeSpan = document.createElement('small');
    timeSpan.className = 'text-muted ms-2';
    timeSpan.textContent = formatTimeAgo(created_at);

    messageDiv.appendChild(userBadge);
    messageDiv.appendChild(messageText);
    messageDiv.appendChild(timeSpan);

    return messageDiv;
  }

  chatSocket.onmessage = function (e) {
    const data = JSON.parse(e.data);

    // Handle chat history when connecting
    if (data.history) {
      // Clear any existing content
      chatContainer.innerHTML = '';

      // Add each message from history
      data.history.forEach(item => {
        const messageElement = createMessageElement(
          item.username,
          item.message,
          item.created_at
        );
        chatContainer.appendChild(messageElement);
      });
    }
    // Handle new individual messages
    else if (data.message) {
      const messageElement = createMessageElement(
        data.username,
        data.message,
        data.created_at
      );
      chatContainer.appendChild(messageElement);
    }

    // Auto-scroll to bottom of chat
    chatContainer.scrollTop = chatContainer.scrollHeight;
  };

  chatSocket.onclose = function (e) {
    console.error('Chat socket closed unexpectedly');
  };

  document.querySelector('#chat-message-input').focus();
  document.querySelector('#chat-message-input').onkeyup = function (e) {
    if (e.key === 'Enter') {  // enter, return
      document.querySelector('#chat-message-submit').click();
    }
  };

  document.querySelector('#chat-message-submit').onclick = function (e) {
    const messageInputDom = document.querySelector('#chat-message-input');
    const message = messageInputDom.value;
    if (message.trim()) {
      chatSocket.send(JSON.stringify({
        'message': message
      }));
      messageInputDom.value = '';
    }
  };

  // store user data, courses, notifications
  let userData;
  let courses = [];
  let notifications = [];

  // function to fill courses student enrolled in 
  async function fillStudentEnrolledCourses(userData, courses) {
    try {
      const enrolmentsResponse = await fetch('/api/enrolments');
      const enrolmentsData = await enrolmentsResponse.json();
      const enrolledCoursesIds = enrolmentsData.filter(enrolment => enrolment.student === userData.id).map(enrolment => enrolment.course);
      console.log(enrolledCoursesIds);

      const coursesContainer = document.getElementById('courses-container');
      coursesContainer.innerHTML = '';

      // Filter courses to only include those that the student is enrolled in
      const enrolledCourses = courses.filter(course => enrolledCoursesIds.includes(course.id));

      if (enrolledCourses.length === 0) {
        coursesContainer.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-mortarboard h1 d-block mb-3"></i>No courses yet. Click "Find Courses" to enroll in a course.</div>';
        return;
      }

      // fill course cards with enrolled courses
      enrolledCourses.forEach(course => {
        const courseCard = `
          <div class="col-md-6 col-xl-4">
            <div class="card h-100 border-0 shadow-sm rounded-4 hover-shadow transition-all overflow-hidden">
              <div class="card-body p-4 d-flex flex-column">
                <div class="d-flex justify-content-between mb-3">
                  <h5 class="fw-bold card-title mb-0 text-primary">${course.title}</h5>
                </div>
                
                <p class="card-text text-muted">${course.description}</p>
                
                <div class="mt-3 pt-3 border-top mt-auto">
                  <a href="/course/${course.id}" class="btn btn-sm btn-primary rounded-pill px-3 w-100">Go to Course</a>
                </div>
              </div>
            </div>
          </div>
        `;
        coursesContainer.innerHTML += courseCard;
      });

      // Add CSS for hover effect
      const style = document.createElement('style');
      style.textContent = `
        .hover-shadow:hover {
          transform: translateY(-5px);
          box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
        }
        .transition-all {
          transition: all 0.3s ease;
        }
      `;
      document.head.appendChild(style);

    } catch (error) {
      console.error('Error fetching courses: ', error);
    }
  }

  // fill notification cards
  async function fillNotifications(notifications) {
    const notificationsContainer = document.getElementById('notifications-container');
    notificationsContainer.innerHTML = '';

    if (notifications.length === 0) {
      notificationsContainer.innerHTML = '<div class="text-center py-4 text-muted"><i class="bi bi-bell-slash h1 d-block mb-3"></i>No notifications yet.</div>';
      return;
    }

    notifications.forEach(notification => {
      const notificationCard = `
        <div class="card mb-2 border-0 bg-light rounded-3">
          <div class="card-body p-3">
            <div class="d-flex">
              <div class="flex-shrink-0 me-3">
                <div class="bg-info bg-opacity-10 p-2 rounded-circle">
                  <i class="bi bi-info-circle-fill text-info"></i>
                </div>
              </div>
              <div>
                <p class="card-text mb-1 small">${notification.message}</p>
                <small class="text-muted">${formatTimeAgo(notification.created_at)}</small>
              </div>
            </div>
          </div>
        </div>
      `;
      notificationsContainer.innerHTML += notificationCard;
    });
  }

  // Window onload handler
  window.onload = async function () {
    // fetch user data, courses, notifications
    userData = await getUserData();
    courses = await getCourses();
    notifications = await getNotifications();

    // fill profile details
    await fillProfile(userData);

    // fill courses student enrolled in
    await fillStudentEnrolledCourses(userData, courses);

    // fill notification cards
    await fillNotifications(notifications);
  }
</script>
{% endblock %}