{% extends 'base.html' %}
{% block content %}
<div class="container-fluid py-4">
  <!-- Profile Header Card -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
        <div class="card-body p-0">
          <div class="row g-0">
            <div class="col-md-4 bg-light p-4 d-flex align-items-center justify-content-center border-end">
              <div class="text-center">
                <div class="position-relative d-inline-block mb-3">
                  <img id="photo" src="" alt="Profile Photo" class="rounded-circle object-fit-cover border shadow-sm" style="width: 120px; height: 120px;">
                </div>
                <h4 id="fullname" class="fw-bold mb-1">Loading...</h4>
                <p id="username" class="text-muted mb-1">Loading...</p>
                <span id="role" class="badge bg-primary text-white mb-2">Loading...</span>
              </div>
            </div>
            <div class="col-md-8 p-4">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 id="profile-header" class="fw-bold mb-0">Profile</h3>
              </div>
              <p id="status" class="text-muted mb-0">Loading status...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Courses Section -->
  <div class="row">
    <div class="col-12">
      <div class="card border-0 rounded-4 shadow-sm">
        <div id="courses-header" class="card-header bg-primary text-white py-3 d-flex justify-content-between align-items-center border-0 rounded-top-4">
          <h5 class="fw-bold mb-0">
            <i class="bi bi-book me-2"></i>Courses
          </h5>
        </div>
        <div class="card-body">
          <div id="courses-container" class="row g-3 pb-1" style="max-height: 600px; overflow-y: auto;">
            <!-- Courses will be dynamically loaded here -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
    let courses = [];
    let user;
    let role;
    let enrolments;
    let userEnrolments;

    async function fillContent() {
        const profileHeader = document.getElementById('profile-header');
        profileHeader.textContent = `${user.full_name}'s Profile`;
        
        // Change background color based on role
        const coursesHeader = document.getElementById('courses-header');
        const roleTag = document.getElementById('role');
        
        if (role == 'student') {
            roleTag.classList.remove('bg-primary');
            roleTag.classList.add('bg-info');
        }
        
        const coursesContainer = document.getElementById('courses-container');
        coursesContainer.innerHTML = '';
        let coursesToFill;
        
        if (role == 'student') {
            userEnrolmentsCourseIds = userEnrolments.map(enrolment => enrolment.course);
            coursesToFill = courses.filter(course => userEnrolmentsCourseIds.includes(course.id));
        } else {
            coursesToFill = courses.filter(course => course.teacher == user.id);
        }
        
        try {
            if (coursesToFill.length === 0) {
                coursesContainer.innerHTML = '<div class="col-12 text-center py-5 text-muted"><i class="bi bi-book h1 d-block mb-3"></i>No courses available.</div>';
                return;
            }
            
            coursesToFill.forEach(course => {              
                const courseCard = `
                    <div class="col-md-6 col-xl-4">
                        <div class="card h-100 border-0 shadow-sm rounded-4 hover-shadow transition-all">
                            <div class="card-body p-4">
                                <div class="d-flex justify-content-between mb-3">
                                    <h5 class="fw-bold card-title mb-0 text-primary">${course.title}</h5>
                                </div>
                                <p class="card-text text-muted">${course.description}</p>
                                <div class="mt-3 pt-3 border-top mt-auto">
                                    <a href="/course/${course.id}" class="btn btn-sm btn-primary rounded-pill px-3 w-100">Go to Course</a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                coursesContainer.innerHTML += courseCard;
            });
        } catch (error) {
            console.error('Error fetching courses: ', error);
        }
    }

    window.onload = async function () {
        courses = await getCourses();
        user = await getUserData('{{ user_id }}')
        role = user.role;
        enrolments = await getEnrolments();
        userEnrolments = await enrolments.filter(enrolment => enrolment.student == user.id);
        await fillProfile(user);
        await fillContent();
    }
</script>
{% endblock %}